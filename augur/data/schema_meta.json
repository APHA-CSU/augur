{
    "type" : "object",
    "$schema": "http://json-schema.org/draft-06/schema#",
    "version": "2.0",
    "title": "Nextstrain metadata JSON schema proposal",
    "additionalProperties": false,
    "required": ["version", "title", "updated", "maintainers", "panels"],
    "properties" : {
        "version" : {
            "description": "JSON schema version",
            "type" : "string",
            "pattern": "^[0-9]+[.][0-9]+$"
        },
        "title" : {
            "description": "Auspice displays this at the top of the page",
            "type" : "string"
        },
        "updated" : {
            "description": "Auspice displays this (currently only in the footer)",
            "type" : "string",
            "pattern": "^[0-9X]{4}-[0-9X]{2}-[0-9X]{2}$"
        },
        "maintainers": {
            "description": "Who maintains this dataset?",
            "$comment": "order similar to a publication",
            "type": "array",
            "uniqueItems": true,
            "minItems": 1,
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "href": {"type": "string"}
                }
            }
        },
        "author_info": {
            "description": "Used to display information about terminal nodes & for filtering by author (if \"authors\" is in \"filters\", see below)",
            "$comment": "Keys are first authors last name + year of publication + first word of title, all in lowercase. E.g. \"white2015isolation\"",
            "$comment": "Keys must exist in the attrs object of at least one terminal node of the tree",
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                "^[a-z-]+[0-9]{4}[a-z-]+$": {
                    "type": "object",
                    "additionalProperties": false,
                    "$comment": "Unknown properties should simply be excluded",
                    "properties": {
                        "authors": {
                            "description": "Authors",
                            "$comment": "Case is respected by auspice",
                            "type": "string"
                        },
                        "title": {
                            "description": "Publication title",
                            "type": "string"
                        },
                        "journal": {
                            "description": "Journal title",
                            "type": "string"
                        },
                        "href": {
                            "description": "URL link to paper or NCBI genome.",
                            "type": "string",
                            "pattern": "^https?://.+$"
                        }
                    }
                }
            }
        },
        "genome_annotations": {
            "description": "Genome annotations (e.g. genes), relative to the reference genome",
            "$comment": "Required for the entropy panel",
            "type": "object",
            "required": ["nuc"],
            "additionalProperties": false,
            "properties": {
                "nuc": {
                    "type": "object",
                    "$comment": "I imagine this can get more complex at some point",
                    "properties": {
                        "start": {
                            "description": "Gene start position (one-based)",
                            "type": "number"
                        },
                        "end": {
                            "description": "Gene end position (one-based)",
                            "type": "number"
                        },
                        "strand": {
                            "description": "Positive or negative strand",
                            "$comment": "not yet used by Auspice",
                            "type": "number",
                            "enum": [-1, 1]
                        }
                    }
                }
            },
            "patternProperties": {
                "^[a-zA-Z0-9]+$": {"$ref": "#/properties/annotations/properties/nuc"}
            }
        },
        "filters": {
            "description": "These appear as filters in the footer of Auspice (which populates the displayed values based upon the tree)",
            "$comment": "These values must be present as keys on a tree node -> trait",
            "type": "array",
            "uniqueItems": true,
            "items": {"type": "string"}
        },
        "panels": {
            "description": "Which panels should Auspice display?",
            "$comment": "If additional JSONs are required (e.g. for frequencies), they will be fetched after parsing this array",
            "type": "array",
            "items": {
                "type": "string",
                "enum": ["tree", "map", "frequencies", "entropy"]
            },
            "uniqueItems": true,
            "minItems": 1
        },
        "geographic_info": {
            "description": "The available options for the geographic resolution dropdown, and their lat/long information",
            "$comment": "Properties here specify the values of the geographic resolution dropdown in Auspice. They must be specified on the tree via node -> traits -> X",
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                "^[a-z]+$": {
                    "description": "The deme names & lat/long info for this geographic resolution",
                    "$comment": "Each value defined across the tree needs to be present here, else Auspice cannot display the deme appropriately",
                    "type": "object",
                    "patternProperties": {
                        "^[a-z_]+$": {
                            "description": "Lat/long info for this deme",
                            "$comment": "one day this may define a shape / polygon",
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                                "latitude": {
                                    "type": "number",
                                    "minimum": -90,
                                    "maximum": 90
                                },
                                "longitude": {
                                    "type": "number",
                                    "minimum": -180,
                                    "maximum": 180
                                }
                            }
                        }
                    }
                }
            }
        },
        "color_bys": {
            "description": "Available colorBys for Auspice",
            "$comment": "The property names are found on node->traits, where the value there defines the deme for that node",
            "$comment": "There are a few exceptions - a property of 'numDate', 'gt' (genotype) or 'authors' are interpreted differently by Auspice as they are defined on the node itself, not node->traits",
            "$comment": "Property strings are not themselves displayed in auspice.",
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                "^[A-Za-z_-]+$": {
                    "type": "object",
                    "required": ["title", "type"],
                    "properties": {
                        "title": {
                            "description": "Text to be displayed in the \"color by\" dropdown and the tree legend",
                            "$comment": "string is parsed unchanged by Auspice",
                            "type": "string"
                        },
                        "type": {
                            "description": "Dictates how the color scale should be constructed",
                            "type": "string",
                            "enum": ["continuous", "discrete", "ordinal"]
                        },
                        "domain": {
                            "description": "Color scale domain",
                            "$comment": "only used if type is continuous",
                            "type": "array",
                            "items": [
                                {"type": "number"},
                                {"type": "number"}
                            ]
                        },
                        "scale": {
                            "description": "Color scale",
                            "$comment": "We could accept strings such as 'viridis', 'rainbow' etc",
                            "$comment": "or an array of hex values to construct a scale over"
                        },
                        "hex_map": {
                            "description": "Links values to colors. Only used if \"type\" is ordinal or discrete.",
                            "$comment": "A greyscale ramp will be used for missing values (i.e. defined on the tree but not here)",
                            "$comment": "properties match tree nodes -> traits -> propertyName",
                            "type": "object",
                            "patternProperties": {
                                "^[A-Za-z_-]+$": {
                                    "description": "color hex value",
                                    "type": "string",
                                    "pattern": "^#[0-9A-Fa-f]{6}$"
                                }
                            }
                        }
                    }
                }
            }
        },
        "display_defaults": {
            "description": "Set the defaults for certain display options in Auspice. All are optional.",
            "$comment": "Anything able to be encoded in the auspice URL should be an option here, so this will expand over time",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "geo_resolution": {
                    "description": "Default geographic resolution",
                    "$comment": "The value here must be present in the geo object (see above)",
                    "type": "string"
                },
                "color_by": {
                    "description": "Default color by",
                    "$comment": "The value here must be present in the color_options object (see above)",
                    "type": "string"
                },
                "distance_measure": {
                    "description": "Default tree metric",
                    "type": "string",
                    "enum": ["div", "num_date"]
                },
                "map_triplicate": {
                    "description": "Should the map be extended / wrapped around. Useful if transmissions are worldwide.",
                    "type": "boolean"
                }
            }
        }
    }
}
