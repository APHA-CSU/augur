{
    "type" : "object",
    "$schema": "http://json-schema.org/draft-06/schema#",
    "title": "Nextstrain tree JSON schema proposal",
    "additionalProperties": false,
    "required": ["strain"],
    "properties": {
        "strain": {
            "description": "Strain name. Must be unique. No spaces",
            "type": "string"
        },
        "div": {
            "description": "Node (phylogenetic) divergence",
            "$comment": "Cumulative (root = 0)",
            "type": "number"
        },
        "numDate": {
            "$comment": "Sample date in decimal format (e.g. 2012.1234)",
            "$comment": "This is the only date information. We no longer have string dates.",
            "type": "object",
            "required": ["value"],
            "properties": {
                "value": {"type": "number"},
                "confidence": {
                    "description": "Confidence of the node date",
                    "type": "array",
                    "items": [
                        {"type": "number"},
                        {"type": "number"}
                    ]
                }
            }
        },
        "vaccine": {
            "description": "Vaccine information",
            "$comment": "cc richard, trevor",
            "properties": {
                "serum": {
                    "description": "strain used to raise sera (for ???)",
                    "$comment": "Currently in the flu & dengue trees",
                    "type": "boolean"
                },
                "selectionDate": {
                    "description": "Vaccine selection date",
                    "$comment": "this is currently in the metadata JSON",
                    "type": "string",
                    "pattern": "^[0-9X]{4}-[0-9X]{2}-[0-9X]{2}$"
                },
                "startDate": {
                    "description": "Vaccine usage start date",
                    "type": "string",
                    "pattern": "^[0-9X]{4}-[0-9X]{2}-[0-9X]{2}$"
                },
                "endDate": {
                    "description": "When the vaccine was stopped",
                    "$comment": "if vaccine still in use, don't include this property",
                    "type": "string",
                    "pattern": "^[0-9X]{4}-[0-9X]{2}-[0-9X]{2}$"
                }
            }
        },
        "labels": {
            "description": "Node labels",
            "$comment": "Auspice scans this to generate the branch labels dropdown",
            "patternProperties": {
                "^[a-zA-Z0-9]+$": {
                    "$comment": "e.g. clade->3c3a",
                    "$comment": "string is parsed unchanged by Auspice",
                    "type": "string"
                }
            }
        },
        "hidden": {
            "$comment": "If true, Auspice hides the branches from this node to it's children",
            "type": "boolean"
        },
        "mutations": {
            "description": "Mutations occuring between the parent and this node",
            "$comment": "same numbering scheme as used by the meta.JSON -> annotations",
            "$comment": "combining nuc + AAs parallels the metadata -> annotations structure",
            "type": "object",
            "properties":  {
                "nuc": {
                    "description": "nucelotide mutations",
                    "type": "array",
                    "items": {
                      "oneOf": [
                        {"type": "string", "pattern": "^[ATCG-][0-9]+[ATCG-]$"},
                        {"type": "string", "pattern": "^insertion [0-9]+-[0-9]+$", "$comment": "TODO unused by auspice"},
                        {"type": "string", "pattern": "^deletion [0-9]+-[0-9]+$", "$comment": "TODO unused by auspice"}
                      ]
                    }
                }
            },
            "patternProperties": {
                "^[a-zA-Z0-9]+$": {
                    "description": "Amino acid mutations for this gene (or annotated region)",
                    "$comment": "properties must exist in the meta.JSON -> annotation object",
                    "type": "array",
                    "items": {
                      "pattern": "^[A-Z*][0-9]+[A-Z*]$"
                    }
                }
            }
        },
        "url": {
            "description": "URL of the sequence (usually https://www.ncbi.nlm.nih.gov/nuccore/...)",
            "$comment": "Obviously only for terminal nodes",
            "$comment": "If not known/available, don't include this as a property of the node",
            "type": "string",
            "pattern": "^https?://.+$"
        },
        "authors": {
            "description": "Author lookup key for the relevant publication / credit",
            "$comment": "Must have a corresponding entry in the meta JSON author_info property",
            "$comment": "Keys are first authors last name + year of publication + first word of title, all in lowercase. E.g. \"white2015isolation\"",
            "$comment": "Only for terminal nodes",
            "$comment": "If not known/available, don't include this as a property of the node",
            "type": "string",
            "pattern": "^[a-z-]+[0-9]{4}[a-z-]+$"
        },
        "accession": {
            "description": "Sequence accession number",
            "$comment": "Obviously only for terminal nodes",
            "$comment": "If not known/available, don't include this as a property of the node",
            "type": "string",
            "pattern": "^[0-9A-Z]+$"
        },
        "traits": {
            "description": "Inferred Attributes / traits decorations on the nodes",
            "$comment": "dynamically created, i.e. we can't predict them",
            "type": "object",
            "patternProperties": {
                "^.+$": {
                    "description": "Inferred trait",
                    "$comment": "property name is the trait name, e.g. country, cTiterSub, ...",
                    "type": "object",
                    "required": ["value"],
                    "properties": {
                        "value": {
                            "type": ["string", "number"]
                        },
                        "confidence": {
                            "description": "Confidence of the trait date",
                            "$comment": "Should we use different keys for the two structures here?",
                            "type": "array",
                            "oneOf": [
                                {
                                    "type": "array",
                                    "items": [
                                        {"type": "number"},
                                        {"type": "number"}
                                    ]
                                },
                                {
                                    "type": "object",
                                    "$comment": "alternative possibilities & their confidence values",
                                    "patternProperties": {
                                        "^.+$": {
                                            "type": "number",
                                            "minimum": 0.0,
                                            "maximum": 1.0
                                        }
                                    }
                                }
                            ]
                        },
                        "entropy": {
                            "$comment": "Auspice uses this to control opacity of the color-by",
                            "type": "number"
                        }
                    }
                }
            }
        },
        "children": {
            "description": "Child nodes. Recursive structure. Terminal nodes do not have this property.",
            "$comment": "Polytomies (more than 2 items) allowed.",
            "type": "array",
            "minItems": 2,
            "items": {"$ref": "#"}
        }
    }
}
